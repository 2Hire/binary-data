const symbols = require('internal/symbols')
const { decodeCommon } = require('lib/decode')
const Metadata = require('internal/meta')

module.exports = select

function select(...whenTypes) {
  if (whenTypes.length === 0) {
    throw new TypeError('You should set at least one condition type.')
  }

  const result = {
    decode,
    encode() {},
    [symbols.skip]: true,
  }

  return result

  function decode(rstream) {
    decode.bytes = 0
    const context = Metadata.clone(this)

    for (const when of whenTypes) {
      // eslint-disable-next-line no-invalid-this
      const probalyValue = decodeCommon(rstream, when, context)

      if (when[symbols.skip] === true) {
        continue
      }

      decode.bytes = context.bytes
      Metadata.clean(context)

      result[symbols.skip] = false
      return probalyValue
    }

    result[symbols.skip] = true
  }
}
